#!/bin/sh
# Pre-commit hook: Lint staged files before commit
# Ensures code quality and prevents broken commits

echo "üîç Running pre-commit checks..."

# Get staged files
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$')
STAGED_CSS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.css$')
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$')

# Exit early if no relevant files
if [ -z "$STAGED_JS_FILES" ] && [ -z "$STAGED_CSS_FILES" ] && [ -z "$STAGED_MD_FILES" ]; then
  echo "‚úÖ No files to lint"
  exit 0
fi

# Check if node_modules exists (in site directory)
if [ ! -d "site/node_modules" ]; then
  echo "‚ö†Ô∏è  Warning: node_modules not found, skipping lint checks"
  exit 0
fi

# Lint JavaScript/TypeScript files
if [ -n "$STAGED_JS_FILES" ]; then
  echo "üìù Linting JavaScript/TypeScript files..."
  echo "$STAGED_JS_FILES" | xargs npx eslint --fix --max-warnings=0
  ESLINT_EXIT_CODE=$?
  
  if [ $ESLINT_EXIT_CODE -ne 0 ]; then
    echo "‚ùå ESLint found errors. Please fix them before committing."
    exit 1
  fi
  
  # Re-stage fixed files
  echo "$STAGED_JS_FILES" | xargs git add
fi

# Lint markdown files (if markdownlint-cli2 is installed)
if [ -n "$STAGED_MD_FILES" ]; then
  if command -v npx markdownlint-cli2 &> /dev/null; then
    echo "üìù Linting Markdown files..."
    echo "$STAGED_MD_FILES" | xargs npx markdownlint-cli2 --fix
    MARKDOWN_EXIT_CODE=$?
    
    if [ $MARKDOWN_EXIT_CODE -ne 0 ]; then
      echo "‚ö†Ô∏è  Markdown linting found issues (non-blocking)"
    fi
    
    # Re-stage fixed files
    echo "$STAGED_MD_FILES" | xargs git add
  fi
fi

# Run TypeScript type checking (if tsconfig.json exists)
if [ -f "site/tsconfig.json" ]; then
  echo "üîç Type checking TypeScript..."
  cd site && npx tsc --noEmit
  TSC_EXIT_CODE=$?
  cd ..
  
  if [ $TSC_EXIT_CODE -ne 0 ]; then
    echo "‚ùå TypeScript type errors found. Please fix them before committing."
    exit 1
  fi
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
